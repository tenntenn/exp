syntax = "proto3";

package parser.v1;

option go_package = "github.com/tenntenn/exp/gen/parser/v1;parserv1";

// ParserService provides Go code parsing and analysis
service ParserService {
  // Parse analyzes Go source code and returns AST and SSA
  rpc Parse(ParseRequest) returns (ParseResponse) {}
}

// ParseRequest represents a request to parse Go code
message ParseRequest {
  string code = 1;
  string format = 2; // "single" or "txtar"
}

// ParseResponse represents the response from parsing
message ParseResponse {
  ASTNode ast = 1;
  repeated SSAFunction ssa = 2;
  repeated ParseError errors = 3;
}

// Position represents a position in source code
message Position {
  int32 line = 1;
  int32 column = 2;
  int32 offset = 3;
}

// ASTNode represents a node in the AST
message ASTNode {
  string type = 1;
  Position start = 2;
  Position end = 3;
  string value_json = 4; // JSON-encoded value
  repeated ASTNode children = 5;
}

// SSAFunction represents a function in SSA form
message SSAFunction {
  string name = 1;
  string package = 2;
  string location = 3;
  repeated Instruction instructions = 4;
  repeated BasicBlock blocks = 5;
}

// Instruction represents a single SSA instruction
message Instruction {
  int32 index = 1;
  string text = 2;
  string opcode = 3;
  Position position = 4;
  int32 block = 5;
}

// BasicBlock represents a basic block in SSA
message BasicBlock {
  int32 index = 1;
  repeated int32 instructions = 2;
  repeated int32 successors = 3;
  repeated int32 predecessors = 4;
}

// ParseError represents a parse or type-checking error
message ParseError {
  string message = 1;
  Position position = 2;
  string severity = 3; // "error" or "warning"
}
